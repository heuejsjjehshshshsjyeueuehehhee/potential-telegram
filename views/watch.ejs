<%- include('partials/header') %>
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<style>
    /* ðŸŸ¡ PLAYER SCREEN */
    .player-screen { 
        width: 100%; 
        min-height: 100vh; 
        background: #000; 
        padding-top: 60px; /* Navbar Space */
    }

    /* ðŸŸ¢ NEW STATIC WRAPPER (Renamed IDs to block floating) */
    .static-video-wrapper {
        width: 100%;
        max-width: 100%; /* Full Screen Width */
        background: #000;
        position: relative;
        z-index: 10;
        aspect-ratio: 16/9;
        margin: 0 auto;
        display: block !important; /* Force Block */
    }
    
    .plyr { width: 100%; height: 100%; }

    /* INFO SECTION */
    .player-info { 
        max-width: 1400px; 
        margin: 0 auto; 
        padding: 25px 20px; 
    }

    /* Episode Meta */
    .ep-meta-box {
        border-left: 4px solid var(--primary);
        padding-left: 15px;
        margin-bottom: 25px;
    }
    .ep-meta-text { color: #ccc; font-size: 15px; }
    .ep-highlight { color: var(--primary); font-weight: 800; font-size: 16px; }

    /* CONTROLS ROW */
    .controls-row { 
        display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; 
    }
    
    .btn-control {
        flex: 1; text-align: center; padding: 14px; border-radius: 8px;
        font-weight: 700; font-size: 15px; text-decoration: none; display: flex; 
        align-items: center; justify-content: center; gap: 10px; transition: 0.2s;
        text-transform: uppercase; letter-spacing: 0.5px;
    }

    .btn-details {
        background: rgba(255, 255, 255, 0.05); 
        border: 2px solid var(--primary); 
        color: var(--primary);
        max-width: 200px;
    }
    .btn-details:hover { background: var(--primary); color: #000; }

    .btn-next { 
        background: var(--primary); 
        color: #000; 
        border: 2px solid var(--primary); 
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }
    .btn-next:hover { 
        background: #fff; border-color: #fff; transform: translateY(-2px);
    }

    /* ðŸ”¢ EPISODE GRID */
    .ep-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
        gap: 12px; margin-top: 20px;
    }
    
    .ep-btn {
        background: #151515; 
        color: #ddd !important; /* Force White Text */
        text-align: center; padding: 14px 0;
        border-radius: 8px; font-weight: 600; font-size: 14px; text-decoration: none; 
        border: 1px solid #333; transition: all 0.2s; display: block;
    }
    
    .ep-btn:hover { 
        border-color: var(--primary); color: #fff !important; transform: translateY(-3px); 
    }
    
    .ep-btn.active { 
        background: var(--primary) !important; 
        color: #000 !important; 
        font-weight: 900 !important; 
        border-color: var(--primary) !important; 
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        transform: scale(1.05);
    }

    /* Dropdown */
    .season-selector-container { position: relative; min-width: 160px; z-index: 50; }
    .season-trigger {
        background: #222; color: #fff; padding: 10px 20px;
        border-radius: 50px; border: 1px solid #444; 
        cursor: pointer; font-size: 14px; font-weight: 700;
        display: flex; justify-content: space-between; align-items: center; gap: 10px;
        transition: 0.3s;
    }
    .season-trigger:hover { border-color: var(--primary); color: var(--primary); }
    
    .season-options {
        position: absolute; top: 120%; right: 0; width: 100%; 
        background: #1a1a1a; border: 1px solid #444; border-radius: 12px; padding: 8px;
        display: none; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.9);
    }
    .season-options.open { display: block; animation: fadeIn 0.2s; }
    
    .season-opt { 
        padding: 12px; color: #ccc; cursor: pointer; border-radius: 8px; font-size: 14px; margin-bottom: 2px;
    }
    .season-opt:hover { background: #333; color: #fff; }
    .season-opt.active { 
        color: var(--primary); font-weight: bold; background: rgba(255, 180, 58, 0.15); 
    }

    button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
</style>

<div class="player-screen">
    
    <div class="static-video-wrapper" id="staticPlayerBox">
        <% if(currentEpisode.url.includes('.mp4') || currentEpisode.url.includes('.m3u8')) { %>
            <video id="player" playsinline controls data-poster="<%= anime.thumbnail %>">
                <source src="<%= currentEpisode.url %>" type="application/x-mpegURL" />
            </video>
        <% } else { %>
            <div class="plyr__video-embed" id="player">
                <iframe src="<%= currentEpisode.url %>" allowfullscreen allowtransparency allow="autoplay"></iframe>
            </div>
        <% } %>
    </div>

    <div class="player-info">
        <h1 style="color:white; font-size:2rem; margin: 0 0 10px 0; font-weight:800; letter-spacing:1px;"><%= anime.title %></h1>
        
        <div class="ep-meta-box">
            <div class="ep-meta-text">
                Watching <span class="ep-highlight">Season <%= currentSeason %></span> - Episode <span class="ep-highlight"><%= currentEpisode.episode %></span>
            </div>
        </div>

        <div class="controls-row">
            <a href="/anime/<%= anime.slug %>" class="btn-control btn-details">
                <i class="fas fa-info-circle"></i> View Details
            </a>
            
            <% if(nextEpisodeLink) { %>
                <a href="<%= nextEpisodeLink %>" class="btn-control btn-next">
                    Next Episode <i class="fas fa-forward"></i>
                </a>
            <% } else { %>
                 <button disabled class="btn-control" style="background:#222; color:#555;">No Next Episode</button>
            <% } %>
        </div>

        <hr style="border:0; border-top:1px solid #333; margin-bottom:30px; opacity: 0.5;">

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="font-size:1.2rem; color:white; font-weight:700; border-bottom: 2px solid var(--primary); padding-bottom:5px;">
                Episodes List
            </h3>
            
            <div class="season-selector-container" id="seasonDropdown">
                <div class="season-trigger" onclick="toggleSeasonMenu()">
                    <span id="seasonTriggerText">Season <%= currentSeason %></span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="season-options" id="seasonOptions">
                    <% anime.seasons.forEach(s => { %>
                        <div class="season-opt <%= currentSeason == s.season ? 'active' : '' %>" 
                             id="opt-season-<%= s.season %>"
                             onclick="selectSeason('<%= s.season %>')">
                            Season <%= s.season %>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>

        <div class="ep-list-container">
            <% 
                let globalEpCounter = 0; 
                anime.seasons.sort((a,b) => a.season - b.season).forEach(season => { 
            %>
                <div class="season-group ep-grid" id="season-<%= season.season %>" 
                     style="display: <%= currentSeason == season.season ? 'grid' : 'none' %>;">
                    
                    <% season.episodes.forEach((ep, index) => { 
                        globalEpCounter++; 
                        let myEpNumber = ep.episode || (index + 1);
                        let isActive = (parseInt(currentEpisode.episode) === parseInt(myEpNumber)) && 
                                       (parseInt(currentSeason) === parseInt(season.season));
                    %>
                        <a href="/watch/<%= anime.slug %>?season=<%= season.season %>&episode=<%= myEpNumber %>" 
                           class="ep-btn <%= isActive ? 'active' : '' %>">
                            <%= globalEpCounter %>
                        </a>
                    <% }) %>
                </div>
            <% }) %>
        </div>
    </div>
</div>

<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('player');
        const source = "<%= currentEpisode.url %>";

        const playerConfig = {
            controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip', 'fullscreen'],
            autoplay: false
        };

        if (source.includes('.m3u8') && Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(source);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, function () {
                const availableQualities = hls.levels.map((l) => l.height);
                playerConfig.quality = { default: availableQualities[0], options: availableQualities, forced: true, onChange: (e) => updateQuality(e) };
                new Plyr(video, playerConfig);
            });
            window.hls = hls;
        } else {
            new Plyr('#player', playerConfig);
        }

        // Close dropdown logic
        document.addEventListener('click', function(e) {
            const container = document.getElementById('seasonDropdown');
            if (!container.contains(e.target)) {
                document.getElementById('seasonOptions').classList.remove('open');
            }
        });
    });

    function updateQuality(newQuality) {
        if(window.hls) {
            window.hls.levels.forEach((level, levelIndex) => {
                if (level.height === newQuality) window.hls.currentLevel = levelIndex;
            });
        }
    }
    
    function toggleSeasonMenu() { 
        document.getElementById('seasonOptions').classList.toggle('open');
    }
    
    function selectSeason(seasonNum) {
        document.querySelectorAll('.season-group').forEach(el => el.style.display = 'none');
        document.getElementById('season-' + seasonNum).style.display = 'grid';
        document.getElementById('seasonTriggerText').innerText = "Season " + seasonNum;
        
        document.querySelectorAll('.season-opt').forEach(el => el.classList.remove('active'));
        document.getElementById('opt-season-' + seasonNum).classList.add('active');
        
        toggleSeasonMenu();
    }
</script>

<%- include('partials/bottom_nav') %>
<%- include('partials/footer') %>
<script>
    // Ye code apne aap chalega jab page load hoga
    (function saveHistory() {
        const animeId = "<%= anime.id %>";
        const title = "<%= anime.title %>";
        const episode = "<%= currentEpisode.episode %>";
        const season = "<%= currentSeason %>";
        const thumbnail = "<%= anime.thumbnail %>";
        const link = window.location.href; // Current URL

        let history = JSON.parse(localStorage.getItem('weeb_history')) || [];

        // Remove if already exists (to update position)
        history = history.filter(h => h.id !== animeId);

        // Add to top
        history.unshift({
            id: animeId,
            title: title,
            ep: episode,
            season: season,
            img: thumbnail,
            link: link,
            date: Date.now()
        });

        // Limit to 10 items
        if (history.length > 10) history.pop();

        localStorage.setItem('weeb_history', JSON.stringify(history));
    })();
</script>